---
title: 聊一聊前端部署
mathjax: true
comments: true
date: 2023-04-19 21:25:20
password: mxdhsbnfxl,kw
tags:
    - develop
categories:
    - deploy
---
## 当我们聊前端部署时，我们在聊什么？

### 尝试回答以下问题？

1. 前端代码从本地的`tsx/jsx`到部署上线被用户访问，中间大致会经历哪些过程？
2. 浏览器的缓存策略你知道多少？前端各种打包产物（HTML,JS,CSS,IMAGES）等应该采用什么缓存策略？为什么？
3. 前端的静态资源如何组织？（CDN??）
4. 自动化构建 & 部署过程如何与CDN结合？
5. 如何避免前端上线，影响未刷新页面的用户？ 
6. 【难】上线版本存在阻塞性BUG，如何做到秒级回滚，而不是每次部署等20分钟乃至更久？
7. 【难】如何实现一个预发环境，除了前端资源外都是线上环境，将变量控制在前端环境内？
8. 如何实现一套前端代码，发布成多套环境产物？

### 静态资源组织

前端打包后的资源只需要通过Nginx进行简单的配置，即可让用户访问，这个过程我们要考虑什么呢？

1. 每次用户访问静态文件，都需要发起请求从服务器重新获取，即使这些资源未发生变化？
    - 协商缓存（协商请求要比每次获取资源更快，但貌似还是不够快）
    - 强缓存（只要未到时间，就一直读取本地缓存（disk Cache））
        - 一般`index.html`会走协商缓存，其他静态资源走强缓存（想一想为什么？）

2. 如果强缓存期间这些静态资源更新了怎么办？
    - 打包文件hash命名，hash与文本内容有关，文本无变化则hash值不变
        - 这是`name-hash`，历史上曾有`query-hash`的方式，其因为会导致覆盖式发布问题而废弃，感兴趣的可以自行搜索

3. 与CDN结合？
    - 前面我们是假设打包后的静态资源部署在Nginx服务器目录下
    - 实际我们会将这些静态资源部署到CDN上以优化用户访问速度，同时也是Nginx和静态资源解耦，只负责转发，代理功能
    - 此时需要先将`静态产物部署到CDN`，再将`Nginx的流量转发到CDN`，也即`反向代理`

这一改造需要前端在Webpack等打包工具构建时进行一定改造，也即依据环境变量为HTML中静态资源加上`CDN域名`，简单来讲需要进行以下修改：

```javascript
/*
    开发机打包时注入
    一般小作坊打包都是在本地，也可写死
*/
const CDN_HOST =process.env.CDN_HOST;
const CDN_PATH =process.env.CDN_PATH;
//...

const getPublicPath =()=>{
    return `${CDN_HOST}/${CDN_PATH}/${ENV}/` //env可以帮助我们一套代码部署到多套前端环境：prod/env
}
const publicPath =process.env.NODE_ENV ==='production' ? getPublicPath() : '.';
module.exports ={
    output:{
        filename:'bundle.[name][contenthash:8].js',
        publicPath
    },
    plugins: [
        new HtmlWebpackPlugin()
    ]
}
```
> 使用 contenthash 时，往往会增加一个小模块后，整体文件的 hash 都发生变化，原因为Webpack 的 module.id 默认基于解析顺序自增，从而引发缓存失效.具体可通过设置 `optimization.moduleIds` 设置为 `deterministic`。

### 自动化构建

第一个问题，从本地代码到用户访问，要做哪些事情呢？（小作坊只需要前端开发人员本机执行一次`yarn run build`即可）

`拉取远程仓库代码` --> `切换到指定分支（一般是master）` --> `安装依赖（node版本？npm源？）` --> `编译，打包出静态资源` --> `静态资源上传CDN` --> `通知构建完成`

这其中有哪些问题呢？

1. 什么环境中执行构建？如何保证开发和生产打包下环境一致性（docker）
2. 如何触发构建？(Jenkins？)
3. 如何自动化执行上述步骤？（GitLab Webhook）

### 前端发布服务

> 此时我们搞定了前端静态资源组织，也搞定了自动化构建部署，也配好了`Nginx`反向代理，网站上线之后，我们要思考哪些问题呢？

1. 预发环境功能：便于测试
2. 版本管理功能：便于回滚
3. 小流量测试，灰度上线等等功能

#### 静态资源加工

例如：自从前后端分离之后，SPA就极为盛行，但这也导致首屏加载时间较长，因为我们除了请求`index.html`还要请求很多`js`文件，并等到对应脚本文件执行之后才能看到渲染之后的页面，如何改造呢？可以针对`index.html`单独设计，通过`BFF`或后端直出`HTML`

#### Pre环境，灰度上线的常见实现

如前面所述，我们的资源非覆盖式发布，通过版本隔离存储，实现Pre/灰度上线的思路就是：`通过一定的机制`，让特定用户访问特定静态资源版本。

1. Nginx层动态转发
    - 开发者通过`ModHeader`插件，在请求中携带特定的Header（`xx-env=pre`），在Nginx层消费该Header并动态转发到对应环境的静态资源上，实现访问Pre环境目的。
    - 不过该方法仅适合工程师，对于用户当然是不切实际的（不过Nginx不通过`Header`可以通过其他比如`Nginx GeoIP`获取地域信息达到按地域灰度）
2. 动态配置+服务端转发
    - 所谓动态配置即引入配置中心（字节这里称之为TCC），独立的平台/SDK，提供动态配置管理的解决方案，后端应用通过接口消费，故配置中心和后端也是解耦的，可以随时更改配置而不用发版。
3. Goofy？

### 字节DevOps研发体系

1. SCM：代码控制管理，字节内部通用的`代码编译发布`和`版本管理平台`，上游对接`Codebase`仓库，下游为`ICM镜像平台(用于镜像管理)`，TCE等平台
    - 通过SCM打包（本质上是在容器环境中执行`build.sh`），将静态资源传送至CDN回源机
    - 触发任务（jenkins pipeline）--编译镜像拉取--代码拉取--安全/通过检查（Argos等平台）--执行编译--打包/上传
2. TCE:公司的通用部署平台，类似于阿里云的ECS
    - 新建服务（PSM）--新建集群（多机房，Region、IDC等概念的区别？）
3. TLB：管理服务域名流量入口的七层负载均衡服务，申请域名并于TCE绑定在一起
4. Goofy：基于Go服务的前端发布系统，专注于前端页面快速部署的平台，基于最小依赖原则，多层兜底方案保证离用户最近的前端页面不挂掉，是提供独立部署能力的前端部署平台
    - Page Server：Goofy最核心的部分，两个作用：托管静态文件，主要包括CSR的html/作为SSR和BFF的网关，将请求正向代理到对应的Faas（公司的ServerLess平台，部署后端服务，解决动态扩缩容问题）函数上